#! /usr/bin/env bash

set -e

git add -N .

if git diff-index --quiet HEAD --; then
  exit 0
fi

if [[ $(git log --since="10 minutes ago") ]]; then
  # if a commit in the last 10 minutes, combine these changes with that commit
  # `git reset HEAD~1` will fail if HEAD is the initial commit
  git reset HEAD~1 &> /dev/null || true
fi

if git diff-index --quiet HEAD --; then
  git push -f
  exit 0
fi

git add .
long_msg=$(git diff --cached --name-only |\
  sort |\
  xargs echo -n |\
  perl -007 -p -e 's{\n}{, }')
short_msg=$(git diff --cached --name-only |\
  xargs basename |\
  sort |\
  xargs echo -n |\
  perl -007 -p -e 's{\n}{, }')
if [[ $(echo -n "$long_msg" | wc -c) -le 50 ]]; then
  git commit -m "$long_msg"
elif [[ $(echo -n "$short_msg" | wc -c) -le 50 ]]; then
  git commit -m "$short_msg" 
else
  git commit -m "(changes too long for a commit message)"
fi

git push -f

